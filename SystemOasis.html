<!DOCTYPE html>
<html>
<head>
    <title>System Oasis</title>
    <meta description="A soothing nebula that flows across all devices, with warm fronts that react to CPU and GPU temperatures."/>
    <meta publisher="Concept by Gemini" />

    <meta property="flowSpeed" label="Flow Speed" type="number" min="1" max="10" default="2" tooltip="Controls the animation speed of the base nebula.">
    
    <meta property="baseHue" label="Oasis Base Hue" type="hue" default="200" min="0" max="360" tooltip="Sets the primary color of the calm, flowing nebula.">

    <meta property="cpuHue" label="CPU Warm Front Hue" type="hue" default="30" min="0" max="60" tooltip="Sets the color for the CPU temperature warning (0=Red, 60=Yellow).">
    
    <meta property="gpuHue" label="GPU Warm Front Hue" type="hue" default="50" min="0" max="60" tooltip="Sets the color for the GPU temperature warning (0=Red, 60=Yellow).">

    <meta property="warningTemp" label="Warning Temperature (°C)" type="number" default="60" min="40" max="90" tooltip="The temperature at which the warm fronts start to appear.">
    <meta property="maxTemp" label="Max Temperature (°C)" type="number" default="85" min="60" max="100" tooltip="The temperature at which the warm fronts reach their maximum intensity.">
</head>

<body style="margin: 0; padding: 0;">
    <canvas id="oasisCanvas" width="320" height="200"></canvas>
</body>

<script>
    //================================================
    // 1. VARIABLE DECLARATIONS & SETUP
    //================================================
    var c = document.getElementById("oasisCanvas");
    var ctx = c.getContext("2d");
    var width = c.width;
    var height = c.height;

    let particles = [];
    const numParticles = 40;

    // The Particle no longer needs a hue when created.
    // It will be assigned one every frame in the update loop.
    function Particle(x, y, vx, vy, radius) {
        this.x = x;
        this.y = y;
        this.vx = vx;
        this.vy = vy;
        this.radius = radius;
        this.hue = 200; // Start with a default blue hue.
    }

    // Helper Functions (no changes here)
    function lerp(val1, val2, t) { return val1 * (1 - t) + val2 * t; }
    function hslToRgb(h, s, l) {
        s /= 100; l /= 100;
        let c = (1 - Math.abs(2 * l - 1)) * s,
            x = c * (1 - Math.abs((h / 60) % 2 - 1)),
            m = l - c/2, r = 0, g = 0, b = 0;
        if (0 <= h && h < 60) { r = c; g = x; b = 0; }
        else if (60 <= h && h < 120) { r = x; g = c; b = 0; }
        else if (120 <= h && h < 180) { r = 0; g = c; b = x; }
        else if (180 <= h && h < 240) { r = 0; g = x; b = c; }
        else if (240 <= h && h < 300) { r = x; g = 0; b = c; }
        else if (300 <= h && h < 360) { r = c; g = 0; b = x; }
        r = Math.round((r + m) * 255); g = Math.round((g + m) * 255); b = Math.round((b + m) * 255);
        return {r: r, g: g, b: b};
    }

    // init() is now simpler, it doesn't need to know about colors.
    function init() {
        for (let i = 0; i < numParticles; i++) {
            particles.push(new Particle(
                Math.random() * width, Math.random() * height,
                (Math.random() - 0.5) * 0.2, (Math.random() - 0.5) * 0.2,
                Math.random() * 50 + 20
            ));
        }
    }

    //================================================
    // 2. THE UPDATE FUNCTION (RUNS EVERY FRAME)
    //================================================
    function update() {
        // --- Safely Get User-Defined Variables ---
        // This pattern checks if the variable from the <meta> tag exists. If not (like in a browser), it uses a default.
        const currentFlowSpeed = typeof flowSpeed !== 'undefined' ? flowSpeed : 2;
        const currentBaseHue = typeof baseHue !== 'undefined' ? baseHue : 200;
        const currentCpuHue = typeof cpuHue !== 'undefined' ? cpuHue : 30;
        const currentGpuHue = typeof gpuHue !== 'undefined' ? gpuHue : 50;
        const currentWarningTemp = typeof warningTemp !== 'undefined' ? warningTemp : 60;
        const currentMaxTemp = typeof maxTemp !== 'undefined' ? maxTemp : 85;

        // --- Safely Get Hardware Data ---
        let cpuTemp = 35; // Start with a default idle temperature
        let gpuTemp = 35;
        
        // This is the key fix: Only try to read temperatures if the `engine` object exists.
        if (typeof engine !== 'undefined' && engine.hw) {
            cpuTemp = engine.hw.cpu?.temperature || 35;
            gpuTemp = engine.hw.gpu?.temperature || 35;
        }

        // --- Clear Canvas with a Trail Effect ---
        ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
        ctx.fillRect(0, 0, width, height);

        // --- Animate and Draw Base Nebula ---
        particles.forEach(p => {
            p.x += p.vx * (currentFlowSpeed / 2);
            p.y += p.vy * (currentFlowSpeed / 2);

            // Wrap particles and assign hue on-the-fly
            if (p.x - p.radius > width) { p.x = -p.radius; p.hue = currentBaseHue + (Math.random() * 40 - 20); }
            if (p.x + p.radius < 0) { p.x = width + p.radius; p.hue = currentBaseHue + (Math.random() * 40 - 20); }
            if (p.y - p.radius > height) { p.y = -p.radius; p.hue = currentBaseHue + (Math.random() * 40 - 20); }
            if (p.y + p.radius < 0) { p.y = height + p.radius; p.hue = currentBaseHue + (Math.random() * 40 - 20); }
            
            let gradient = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.radius);
            gradient.addColorStop(0, `hsla(${p.hue}, 80%, 60%, 0.8)`);
            gradient.addColorStop(1, `hsla(${p.hue}, 80%, 60%, 0)`);
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
            ctx.fill();
        });

        // --- Draw CPU Temperature "Warm Front" ---
        let cpuIntensity = (cpuTemp - currentWarningTemp) / (currentMaxTemp - currentWarningTemp);
        cpuIntensity = Math.max(0, Math.min(1, cpuIntensity));

        if (cpuIntensity > 0) {
            let cpuRgb = hslToRgb(currentCpuHue, 100, 50);
            let cpuGradient = ctx.createRadialGradient(width / 2, height * 0.25, 0, width / 2, height / 2, width * lerp(0.5, 1.0, cpuIntensity));
            cpuGradient.addColorStop(0, `rgba(${cpuRgb.r}, ${cpuRgb.g}, ${cpuRgb.b}, ${cpuIntensity * 0.4})`);
            cpuGradient.addColorStop(1, `rgba(${cpuRgb.r}, ${cpuRgb.g}, ${cpuRgb.b}, 0)`);
            ctx.fillStyle = cpuGradient;
            ctx.fillRect(0, 0, width, height);
        }

        // --- Draw GPU Temperature "Warm Front" ---
        let gpuIntensity = (gpuTemp - currentWarningTemp) / (currentMaxTemp - currentWarningTemp);
        gpuIntensity = Math.max(0, Math.min(1, gpuIntensity));
        
        if (gpuIntensity > 0) {
            let gpuRgb = hslToRgb(currentGpuHue, 100, 50);
            let gpuGradient = ctx.createRadialGradient(width / 2, height * 0.75, 0, width / 2, height / 2, width * lerp(0.5, 1.0, gpuIntensity));
            gpuGradient.addColorStop(0, `rgba(${gpuRgb.r}, ${gpuRgb.g}, ${gpuRgb.b}, ${gpuIntensity * 0.4})`);
            gpuGradient.addColorStop(1, `rgba(${gpuRgb.r}, ${gpuRgb.g}, ${gpuRgb.b}, 0)`);
            ctx.fillStyle = gpuGradient;
            ctx.fillRect(0, 0, width, height);
        }

        window.requestAnimationFrame(update);
    }

    //================================================
    // 3. INITIAL FUNCTION CALLS
    //================================================
    init();
    window.requestAnimationFrame(update);
</script>
</html>