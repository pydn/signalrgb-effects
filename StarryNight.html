<!DOCTYPE html>
<html>
<head>
    <title>Starry Night (Animated)</title>
    <meta description="An animated particle field generated from the Starry Night painting, with a swirling sky and twinkling stars."/>
    <meta publisher="Concept by Gemini" />

    <meta property="particleSize" label="Base Particle Size" type="number" min="0.5" max="4" default="1.5" tooltip="The base size of the smallest particles.">
    <meta property="brightnessFactor" label="Brightness Factor" type="number" min="1" max="10" default="4" tooltip="How much brighter pixels from the painting scale up in size.">
    <meta property="swirlStrength" label="Swirl Strength" type="number" min="0" max="10" default="2" tooltip="The speed of the sky's rotational movement.">
    <meta property="twinkleStrength" label="Twinkle Strength" type="number" min="0" max="10" default="3" tooltip="How intensely the bright stars and moon pulse with light.">

</head>

<body style="margin: 0; padding: 0;">
    <canvas id="mainCanvas" width="320" height="200"></canvas>
    <canvas id="hiddenCanvas" width="320" height="200" style="display:none;"></canvas>
</body>

<script>
    //================================================
    // 1. SETUP & IMAGE LOADING
    //================================================
    const mainCanvas = document.getElementById("mainCanvas");
    const ctx = mainCanvas.getContext("2d");
    const hiddenCanvas = document.getElementById("hiddenCanvas");
    const hiddenCtx = hiddenCanvas.getContext("2d");
    
    const width = mainCanvas.width;
    const height = mainCanvas.height;
    
    const particles = [];

    // Particle now includes velocity and a twinkle offset
    function Particle(x, y, color, brilliance) {
        this.x = x;
        this.y = y;
        this.color = color;
        this.brilliance = brilliance; // How bright the original pixel was (0-1)
        this.twinkleOffset = Math.random() * 100; // Unique offset for twinkling
        
        // Calculate velocity for a swirling motion around the center
        const dx = this.x - width / 2;
        const dy = this.y - height / 2;
        const swirlFactor = 0.0005; // Base speed of the swirl
        this.vx = -dy * swirlFactor;
        this.vy = dx * swirlFactor;
    }

    // Load the Starry Night image
    const image = new Image();
    image.crossOrigin = "Anonymous";
    image.src = 'https://s3-us-west-2.amazonaws.com/s.cdpn.io/223954/StarryNight2.jpg';

    // All logic must be inside image.onload
    image.onload = function() {
        hiddenCtx.drawImage(image, 0, 0, width, height);
        const imageData = hiddenCtx.getImageData(0, 0, width, height);
        
        const pixelSkip = 2; // Create a particle for every 2nd pixel
        for (let y = 0; y < height; y += pixelSkip) {
            for (let x = 0; x < width; x += pixelSkip) {
                const index = (y * width + x) * 4;
                const r = imageData.data[index];
                const g = imageData.data[index + 1];
                const b = imageData.data[index + 2];
                const color = `rgb(${r},${g},${b})`;
                const brilliance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                
                particles.push(new Particle(x, y, color, brilliance));
            }
        }
        
        // Start the animation loop
        render();
    };

    let time = 0;

    //================================================
    // 2. RENDER LOOP
    //================================================
    function render() {
        // Safely get user variables with defaults
        const pSize = typeof particleSize !== 'undefined' ? particleSize : 1.5;
        const bFactor = typeof brightnessFactor !== 'undefined' ? brightnessFactor : 4;
        const sStrength = typeof swirlStrength !== 'undefined' ? swirlStrength : 2;
        const tStrength = typeof twinkleStrength !== 'undefined' ? twinkleStrength : 3;

        time += 0.05;

        // Clear Canvas
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, width, height);

        // Update and Draw Particles
        particles.forEach(p => {
            // --- 1. Animate Position (Swirl) ---
            p.x += p.vx * sStrength;
            p.y += p.vy * sStrength;
            
            // Wrap particles around the screen for a continuous flow
            if (p.x < 0) p.x = width;
            if (p.x > width) p.x = 0;
            if (p.y < 0) p.y = height;
            if (p.y > height) p.y = 0;

            // --- 2. Animate Size (Twinkle) ---
            // A sine wave creates a smooth pulse. The effect is stronger for brighter pixels.
            const twinkleValue = Math.sin(time + p.twinkleOffset);
            const twinkleSize = p.brilliance * twinkleValue * (tStrength / 10);
            
            // --- 3. Draw the Particle ---
            ctx.fillStyle = p.color;
            ctx.beginPath();
            const size = pSize + (p.brilliance * bFactor) + twinkleSize;
            
            // Ensure size is not negative
            if (size > 0.1) {
                ctx.arc(p.x, p.y, size, 0, Math.PI * 2);
                ctx.fill();
            }
        });

        requestAnimationFrame(render);
    }
</script>
</html>